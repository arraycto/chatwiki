import{r as f,A as J,v as P,w as Y,L as i,M as u,V as e,j as S,Q as H,F as O,a1 as R,u as j,P as K,X as F,Y as I,af as Z,a2 as ge,E as N,a3 as U,a4 as V,a8 as M,y as X,a0 as he,a6 as ye,B as Se}from"./vue-chunks-BakLQ6XW.js";import{a as $}from"./dayjs--xR4C_bb.js";import{e as be,_ as q,B as Te}from"../../index-CKV2YGM_.js";import{a as ke,_ as $e}from"./RadioButton-CHLN6Muu.js";import{R as xe}from"./dayjs-BbkjAT4a.js";import{_ as ee}from"./empty-DkpCLaix.js";import{_ as De,u as we}from"./chat-BeYpOO_8.js";import{S as Ie}from"./index-Dpot3w8w.js";import{u as Ce}from"./robot-CB4LKc9F.js";import{S as Ee,_ as Le}from"./index-NA_XKKNF.js";import{_ as He}from"./Search-DYm3uzC8.js";import{_ as Be}from"./index-DsyEAJHc.js";import"./axios-Cm0UX6qg.js";import"./qs-nPXSgJGS.js";import"./crypto-js-KGFlroD9.js";import"./FormItemContext-DR8sO-Ed.js";import"./colors-kBLNjtj1.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./CheckOutlined-ChdhA5t7.js";import"./shallowequal-q0YU5nsK.js";import"./index-DGlOrsZz.js";import"./move-DNO6i3is.js";import"./slide-9w1lpQ9q.js";import"./index-CHu8iap8.js";import"./index-BLc6Irs5.js";import"./index-Bfh3I4I5.js";import"./DownOutlined-Cm3ZSIcr.js";import"./SearchOutlined-Dn9-O_9q.js";import"./Input-BvBM5brR.js";import"./inputProps-Cjz0icZ3.js";const Me={class:"zm-date"},Oe={class:"date-btn"},Ae={class:"date-content"},Re={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(n,{emit:D}){const T=n,d=f(1),_=D;let g=J([{label:"今日",value:!0,key:2,start_time:$().startOf("day"),end_time:$().endOf("day")},{label:"昨日",value:!1,key:3,start_time:$().subtract(1,"day").startOf("day"),end_time:$().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:$().subtract(6,"day").startOf("day"),end_time:$().endOf("day").subtract(1,"millisecond")}]);const p=f(null),a=f(null),o=f([]),h=r=>r>=$().subtract(0,"day"),x=()=>{let r=d.value,s=null;g.forEach(m=>{m.key==r&&(s=m)}),s&&(o.value=[s.start_time,s.end_time],p.value=s.start_time.unix(),a.value=s.end_time.unix()),C()},E=r=>{const s=$(r[0]).startOf("day");if($(r[1]).endOf("day").diff(s,"days")>29)o.value[0]=r[0].startOf("day"),o.value[1]=s.add(29,"days").endOf("day"),p.value=o.value[0].unix(),a.value=o.value[1].unix(),be.error("最多只能选择30天");else{const k=$(r[0]).startOf("day").unix(),l=$(r[1]).endOf("day").unix();o.value=r,p.value=k,a.value=l}d.value=1,C()},C=()=>{_("dateChange",{start_time:p.value,end_time:a.value})};return P(()=>{d.value=parseInt(T.datekey),x()}),Y(()=>T.datekey,(r,s)=>{d.value=parseInt(T.datekey.split("-")[0]),x()}),(r,s)=>{const m=ke,k=$e,l=xe;return i(),u("div",Me,[e("div",Oe,[S(k,{value:d.value,"onUpdate:value":s[0]||(s[0]=t=>d.value=t),onChange:x},{default:H(()=>[(i(!0),u(O,null,R(j(g),t=>(i(),K(m,{class:"date-btn-button",value:t.key,key:t.key},{default:H(()=>[F(I(t.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",Ae,[S(l,{value:o.value,"onUpdate:value":s[1]||(s[1]=t=>o.value=t),onChange:E,format:"YYYY-MM-DD",disabledDate:h,allowClear:!1},null,8,["value"])])])}}},G=n=>(U("data-v-e837d5ae"),n=n(),V(),n),Ue={key:0,class:"empty-box"},Ve=G(()=>e("img",{src:ee,alt:""},null,-1)),qe=G(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),ze=[Ve,qe],je=["onClick"],Ne={class:"user-item-left"},Pe=["src"],Ye={class:"user-item-right"},Fe={class:"user-name-box"},Ge={class:"user-name"},Qe={class:"user-timer"},We={class:"user-info"},Xe={class:"user-source-box"},Je=G(()=>e("div",{class:"user-source-title"},"来自：",-1)),Ke={class:"user-source-content"},Ze={__name:"user",props:{userList:{type:Array,default:[]}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(n,{emit:D}){const T=f(null),d=n,_=D,g=f([]),p=f({}),a=s=>{p.value=s,_("userClick",s)},o={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let h=null;function x(s){h&&(clearTimeout(h),h=null),h=setTimeout(()=>{o.scrollTop-s.target.scrollTop>0&&(o.scrollDirection="up"),o.scrollTop-s.target.scrollTop<0&&(o.scrollDirection="down"),o.scrollTop=s.target.scrollTop,o.scrollHeight=s.target.scrollHeight,o.clientHeight=s.target.clientHeight,_("userScroll",{...o}),Math.abs(o.scrollTop)<=o.scrollStartDiff+100&&o.scrollDirection==="up"&&E(),Math.abs(o.scrollHeight-o.scrollTop-o.clientHeight)<=o.scrollEndDiff&&o.scrollDirection==="down"&&C()},50)}function E(){d.userList.length!=0&&_("userScrollStart",{msg:d.userList[0]})}function C(){d.userList.length!=0&&_("userScrollEnd",{msg:d.userList[d.userList.length-1]})}Y(()=>d.userList,s=>{g.value=s,g.value.length>0&&g.value.length<=20&&(a(g.value[0]),p.value=g.value[0])},{immediate:!0});const r=s=>{let m;switch(s){case"yun_h5":m="WebAPP";break;case"yun_pc":m="嵌入网站";break}return m};return P(()=>{g.value=d.userList}),(s,m)=>{const k=Z("ftime");return i(),u("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:T,onScroll:x},[g.value.length===0?(i(),u("div",Ue,ze)):(i(!0),u(O,{key:1},R(g.value,l=>(i(),u("div",{class:ge(["user-item",{active:l.openid==p.value.openid}]),onClick:t=>a(l),key:l.session_id},[e("div",Ne,[e("img",{class:"user-img",src:l.avatar,alt:""},null,8,Pe)]),e("div",Ye,[e("div",Fe,[e("div",Ge,I(l.name),1),N((i(),u("div",Qe,[F(I(l.last_chat_time),1)])),[[k,"MM-DD HH:mm"]])]),e("div",We,I(l.last_chat_message),1),e("div",Xe,[Je,e("div",Ke,I(r(l.app_type)),1)])])],10,je))),128))],544)}}},et=q(Ze,[["__scopeId","data-v-e837d5ae"]]),te=n=>(U("data-v-f2c3608a"),n=n(),V(),n),tt={class:"message-box"},st={class:"message-top-box"},ot={class:"message-top-title"},at={key:0,class:"message-top-source"},lt={class:"message-list"},nt={key:0,class:"empty-box"},rt=te(()=>e("img",{src:ee,alt:""},null,-1)),ct=te(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),it=[rt,ct],ut=["id"],dt={class:"itme-right"},_t={class:"item-body"},pt={class:"message-content"},mt={class:"user-avatar-box"},vt=["src"],ft=["id"],gt={class:"itme-left"},ht=["src"],yt={class:"itme-right"},St={class:"item-body"},bt={key:0,class:"message-content"},Tt=["innerHTML"],kt={key:2,class:"message-content"},$t=["src"],xt={key:2,class:"loading-box"},Dt={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(n,{expose:D,emit:T}){const d=T,_=n,g=f(!1),p=f(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let o=null,h=!1;const x=l=>{let t;for(let y=0;y<_.channelItem.length;y++){const b=_.channelItem[y];b.app_type===l&&(t=b.app_name)}return t};function E(l){h||(o&&(clearTimeout(o),o=null),o=setTimeout(()=>{a.scrollTop-l.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-l.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=l.target.scrollTop,a.scrollHeight=l.target.scrollHeight,a.clientHeight=l.target.clientHeight,d("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&C(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&r()},100))}function C(){_.messages.length!=0&&d("scrollStart",{msg:_.messages[0]})}function r(){_.messages.length!=0&&d("scrollEnd",{msg:_.messages[_.messages.length-1]})}const s=()=>{p.value&&X(()=>{h=!0,p.value.scrollTop=p.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=p.value.scrollTop,h=!1},50)})};function m(l,t){X(()=>{h=!0,t||(t="top");let y=p.value,b=document.querySelector("#msg-"+l);b&&(t=="top"?y.scrollTop=b.offsetTop:y.scrollTop=b.offsetTop-y.clientHeight+b.clientHeight),setTimeout(()=>{a.scrollTop=p.value.scrollTop,h=!1},50)})}function k(){a.scrollTop=0,a.scrollDirection=""}return D({scrollToBottom:s,scrollToMessage:m,resetScroll:k}),(l,t)=>{const y=Ie,b=Z("viewer");return i(),u("div",tt,[e("div",st,[e("div",ot,I(_.robotInfo.robot_name),1),n.sessionSource?(i(),u("div",at,"("+I(x(n.sessionSource))+")",1)):M("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:p,onScroll:E},[e("div",lt,[_.isEmpty||!_.messages?(i(),u("div",nt,it)):(i(!0),u(O,{key:1},R(_.messages,v=>(i(),u(O,{key:v.uid},[v.is_customer==1?(i(),u("div",{key:0,class:"message-item user-message",id:"msg-"+v.uid},[e("div",dt,[e("div",_t,[e("div",pt,I(v.content),1)])]),e("div",mt,[e("img",{class:"user-avatar",src:v.avatar},null,8,vt)])],8,ut)):(i(),u("div",{key:1,class:"message-item robot-message",id:"msg-"+v.uid},[e("div",gt,[S(y,{size:"small",spinning:v.loading},{default:H(()=>[e("img",{class:"robot-avatar",src:v.robot_avatar},null,8,ht)]),_:2},1032,["spinning"])]),e("div",yt,[e("div",St,[v.msg_type==1?N((i(),u("div",bt,[S(De,{content:v.content},null,8,["content"])])),[[b]]):M("",!0),v.msg_type==2?(i(),u("div",{key:1,class:"message-content",innerHTML:v.menu_json.content},null,8,Tt)):M("",!0),v.msg_type==3?(i(),u("div",kt,[N(e("img",{class:"msg-img",src:v.content,alt:""},null,8,$t),[[b]])])):M("",!0)])])],8,ft))],64))),128)),g.value?(i(),u("div",xt,[S(y)])):M("",!0)])],544)])}}},wt=q(Dt,[["__scopeId","data-v-f2c3608a"]]),se=n=>(U("data-v-551bd668"),n=n(),V(),n),It={class:"team-members-pages"},Ct={class:"set-model"},Et=se(()=>e("div",{class:"label set-model-label"},"渠道：",-1)),Lt={class:"set-model-body"},Ht={class:"set-date"},Bt=se(()=>e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),Mt={class:"set-date-body"},Ot={class:"set-name"},At={class:"set-reset"},Rt={class:"list-box"},Ut={class:"user-box"},Vt={class:"records-box"},qt={__name:"session-record",setup(n){const D=f(!1),T=he(),d=T.query,_=Ce(),{robotInfo:g}=_,p=we(),{messageList:a}=ye(p);let o=!0;const{createMsg:h,onGetChatMessage:x,getRecordList:E,getChannelList:C}=p,r=f(null),s=f([]),m=f([]),k=f(""),l=f("1"),t=J({robot_id:d.id,app_type:"all",app_id:"",start_time:"",end_time:"",name:"",page:1,size:20}),y=f(!1),b=c=>{t.start_time=c.start_time,t.end_time=c.end_time,z()},v=()=>{t.app_type="all",t.name="",t.page=1,l.value="1-"+Math.random()},z=()=>{t.page=1,Q()},oe=c=>{t.app_type=c,z()},ae=()=>{},le=c=>{k.value=c.app_type,_e(c)},ne=async()=>{},re=()=>{y.value&&(t.page++,Q())},ce=async()=>{o=!1;let c=a.value[0].uid;await x()&&ue(c)},ie=()=>{r.value&&o&&r.value.scrollToBottom()},ue=c=>{r.value&&r.value.scrollToMessage(c)},de=()=>{r.value&&r.value.resetScroll()};let A=null;const _e=async c=>{o=!0;let B={robot_key:(T.query||{}).robot_key,avatar:c.avatar,name:c.name,nickname:c.name,is_background:1,openid:c.openid,dialogue_id:c.dialogue_id};de(),await h(B),A&&(clearTimeout(A),A=null),A=setTimeout(async()=>{await x()&&ie()},100)},pe=async()=>{const c=await C();s.value=[{app_type:"all",app_name:"全部渠道"},...c.data]},Q=async()=>{let c={robot_id:t.robot_id,start_time:t.start_time,end_time:t.end_time,name:t.name,page:t.page,size:t.size};t.app_type!=="all"&&(c.app_type=t.app_type);let w=await E(c),B=w.data.list||[];t.page==1&&(m.value=[]),m.value=[...m.value,...B],D.value=m.value.length==0,y.value=w.data.has_more};return Y(()=>a.value,()=>{}),P(async()=>{pe()}),Se(()=>{}),(c,w)=>{const B=Ee,W=Le,me=He,ve=Te,fe=Be;return i(),u("div",It,[S(fe,{justify:"flex-start",class:"screen-box"},{default:H(()=>[e("div",Ct,[Et,e("div",Lt,[S(W,{value:t.app_type,"onUpdate:value":w[0]||(w[0]=L=>t.app_type=L),placeholder:"全部渠道",onChange:oe,style:{width:"200px"}},{default:H(()=>[(i(!0),u(O,null,R(s.value,L=>(i(),K(B,{key:L.app_type,value:L.app_type},{default:H(()=>[e("span",null,I(L.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",Ht,[Bt,e("div",Mt,[S(Re,{onDateChange:b,datekey:l.value},null,8,["datekey"])])]),e("div",Ot,[S(me,{value:t.name,"onUpdate:value":w[1]||(w[1]=L=>t.name=L),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:z},null,8,["value"])]),e("div",At,[S(ve,{onClick:v},{default:H(()=>[F("重置")]),_:1})])]),_:1}),e("div",Rt,[e("div",Ut,[S(et,{userList:m.value,onUserScrollStart:ne,onUserScrollEnd:re,onUserClick:le},null,8,["userList"])]),e("div",Vt,[S(wt,{ref_key:"messageListRef",ref:r,isEmpty:D.value,messages:j(a),robotInfo:j(g),channelItem:s.value,sessionSource:k.value,onScrollStart:ce,onScrollEnd:ae},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])])])}}},zt=q(qt,[["__scopeId","data-v-551bd668"]]),jt=n=>(U("data-v-bcc51f14"),n=n(),V(),n),Nt={class:"user-model-page"},Pt=jt(()=>e("div",{class:"page-title"},"会话记录",-1)),Yt={class:"list-wrapper"},Ft={__name:"index",setup(n){return(D,T)=>(i(),u("div",Nt,[Pt,e("div",Yt,[S(zt)])]))}},ks=q(Ft,[["__scopeId","data-v-bcc51f14"]]);export{ks as default};
